{% extends "base.html" %}
{% block content %}

<div class="page-content claim-page">
  <div class="page-header claim-header">
    <div>
      <h1>Claim {{ claim.claim_slug or ('claim-' ~ claim.id) }}</h1>
      <p class="text-muted">Lead #{{ claim.lead_id }}{% if claim.lead and claim.lead.owner_name %} • {{ claim.lead.owner_name }}{% endif %}</p>
    </div>
    <div class="page-actions claim-actions">
      <a href="/claims" class="btn btn-secondary">Back to Claims</a>
      {% if claim.lead_id %}
      <a href="/leads/{{ claim.lead_id }}/edit" class="btn btn-ghost">View Lead</a>
      {% endif %}
    </div>
  </div>

  <section id="claim-detail" class="card" data-claim-id="{{ claim.id }}" data-owner-name="{{ claim.lead.owner_name if claim.lead else '' }}" data-lead-primary-contact="{{ lead_primary_contact_json | e }}">
    <header>
      <h2>Claim Summary</h2>
    </header>
    <div class="section-content">
      <div class="grid two-column">
        <div>
          <div class="label">Claim Slug</div>
          <div>{{ claim.claim_slug or ('claim-' ~ claim.id) }}</div>
        </div>
        <div>
          <div class="label">Lead</div>
          <div>
            {% if claim.lead_id %}
              <a href="/leads/{{ claim.lead_id }}/edit">Lead #{{ claim.lead_id }}</a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
        <div>
          <div class="label">Control Number</div>
          <div>{{ client.control_no if client else '—' }}</div>
        </div>
        <div>
          <div class="label">Formation State</div>
          <div>{{ client.formation_state if client else '—' }}</div>
        </div>
        <div>
          <div class="label">Fee</div>
          <div>
            {% if claim.fee_flat %}
              ${{ "%.2f"|format(claim.fee_flat) }}
            {% elif claim.fee_pct %}
              {{ claim.fee_pct }}%
            {% else %}
              —
            {% endif %}
          </div>
        </div>
        <div>
          <div class="label">CDR Fee</div>
          <div>{{ "%.2f"|format(claim.cdr_fee) if claim.cdr_fee else '—' }}</div>
        </div>
        <div>
          <div class="label">Total Properties</div>
          <div>{{ claim.total_properties or '—' }}</div>
        </div>
        <div>
          <div class="label">Total Amount</div>
          <div>{{ "$%.2f"|format(claim.total_amount) if claim.total_amount else '—' }}</div>
        </div>
        <div>
          <div class="label">Addendum</div>
          <div>{% if claim.addendum_yes %}Yes{% else %}No{% endif %}</div>
        </div>
        <div>
          <div class="label">Output Directory</div>
          <div>{{ claim.output_dir or '—' }}</div>
        </div>
        <div class="claim-status-row">
          <div class="claim-status-label">
            <div class="label">Current Status</div>
            {% if current_status %}
              <span class="status-pill" id="claim-current-status">{{ current_status }}</span>
            {% else %}
              <span class="text-muted" id="claim-current-status">—</span>
            {% endif %}
          </div>
          <div class="claim-status-actions">
            <span id="claim-status-update" class="text-muted claim-status-message"></span>
            <label for="claim-status-select" class="label">Status:</label>
            <select id="claim-status-select">
              {% for st in claim_status_values %}
                <option value="{{ st }}">{{ st }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn btn-secondary" id="claim-status-btn">Set</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card section-stack" data-claim-id="{{ claim.id }}" id="client-claim-info-section">
    <header>
      <h2>Client & Claim Information</h2>
    </header>
    <div class="section-content">
      <!-- Claim Details Card -->
      <div class="form-group claim-form-card">
        <h3>Claim Details</h3>
        <div class="grid two-column claim-grid-gap-md">
          <div>
            <label for="claim-fee-type" class="claim-form-label-inline">Fee Type</label>
            <select id="claim-fee-type">
              <option value="percentage" {% if not claim.fee_flat %}selected{% endif %}>Percentage</option>
              <option value="flat" {% if claim.fee_flat %}selected{% endif %}>Flat Amount</option>
            </select>
          </div>
          <div id="fee-pct-field" {% if claim.fee_flat %}style="display: none;"{% endif %}>
            <label for="claim-fee-pct" class="claim-form-label-inline">CDR Fee Percentage</label>
            <select id="claim-fee-pct">
              {% set current_fee_pct = claim.fee_pct if claim.fee_pct else 10 %}
              {% for pct in range(5,16) %}
              <option value="{{ pct }}" {% if pct|int == current_fee_pct|int %}selected{% endif %}>{{ pct }}%</option>
              {% endfor %}
            </select>
          </div>
          <div id="fee-flat-field" {% if not claim.fee_flat %}style="display: none;"{% endif %}>
            <label for="claim-fee-flat" class="claim-form-label-inline">CDR Fee (Flat Amount)</label>
            <input type="number" step="0.01" id="claim-fee-flat" value="{{ claim.fee_flat if claim.fee_flat else '' }}" placeholder="0.00">
          </div>
          <div>
            <label for="claim-addendum" class="claim-form-label-inline">Addendum Required?</label>
            <select id="claim-addendum">
              <option value="false" {% if not claim.addendum_yes %}selected{% endif %}>No</option>
              <option value="true" {% if claim.addendum_yes %}selected{% endif %}>Yes</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Client Information Card -->
      <div class="form-group claim-form-card">
        <h3>Client Information</h3>
        <div class="claim-grid-three-col">
          <div>
            <label for="entitled-business-name" class="claim-form-label">Entitled Business Name</label>
            <div class="claim-flex-row">
              <input 
                type="text" 
                id="entitled-business-name" 
                value="{{ claim.entitled_business_name or (claim.lead.owner_name if claim.lead else '') }}"
                {% if claim.entitled_business_same_as_owner %}disabled{% endif %}
                placeholder="Entitled Business Name"
                class="claim-input-flex"
              >
              <label for="entitled-business-same-as-owner" class="claim-checkbox-label">
                <input type="checkbox" id="entitled-business-same-as-owner" class="claim-checkbox-input" {% if claim.entitled_business_same_as_owner %}checked{% endif %}>
                <span>Same as owner</span>
              </label>
            </div>
          </div>
          <div>
            <label for="claim-control-no" class="claim-form-label">Control Number</label>
            <input id="claim-control-no" type="text" value="{{ client.control_no if client else '' }}" placeholder="Enter control number" class="claim-input-full">
          </div>
          <div>
            <label for="claim-formation-state" class="claim-form-label">Formation State</label>
            <select id="claim-formation-state" class="claim-input-full">
              <option value="" {% if not client or not client.formation_state %}selected{% endif %}>-- select --</option>
              {% for st in ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"] %}
              <option value="{{ st }}" {% if client and client.formation_state == st %}selected{% endif %}>{{ st }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Signer Contacts Card -->
      <div class="form-group claim-form-card">
        <!-- <h3 style="margin-top: 0; margin-bottom: 20px; color: #111827; font-size: 16px; font-weight: 600;">Authorized Signers</h3> -->
        
        <!-- Primary Signer -->
        <div class="claim-section-spacing">
          <div class="claim-flex-between claim-margin-bottom-sm">
            <h4>Primary Signer <span class="claim-required-asterisk">*</span></h4>
            <label for="primary-signer-same-as-contact" class="claim-checkbox-label-large">
              <input type="checkbox" id="primary-signer-same-as-contact" class="claim-checkbox-input" {% if primary_contact and lead_primary_contact and primary_contact.lead_contact_id == lead_primary_contact.id %}checked{% endif %}>
              <span>Use primary contact</span>
            </label>
          </div>
          <div class="grid two-column claim-grid-gap-sm">
            <div>
              <label for="primary-signer-first-name" class="claim-form-label-inline">First Name <span class="claim-required-asterisk">*</span></label>
              <input type="text" id="primary-signer-first-name" value="{{ primary_contact.first_name if primary_contact else (lead_primary_contact.contact_name.split(' ')[0] if lead_primary_contact and lead_primary_contact.contact_name else '') }}" placeholder="First name" required {% if primary_contact and lead_primary_contact and primary_contact.lead_contact_id == lead_primary_contact.id %}disabled{% endif %}>
            </div>
            <div>
              <label for="primary-signer-last-name" class="claim-form-label-inline">Last Name <span class="claim-required-asterisk">*</span></label>
              <input type="text" id="primary-signer-last-name" value="{{ primary_contact.last_name if primary_contact else (lead_primary_contact.contact_name.split(' ')[1] if lead_primary_contact and lead_primary_contact.contact_name and ' ' in lead_primary_contact.contact_name else '') }}" placeholder="Last name" required {% if primary_contact and lead_primary_contact and primary_contact.lead_contact_id == lead_primary_contact.id %}disabled{% endif %}>
            </div>
            <div>
              <label for="primary-signer-title" class="claim-form-label-inline">Title <span class="claim-required-asterisk">*</span></label>
              <input type="text" id="primary-signer-title" value="{{ primary_contact.title if primary_contact else (lead_primary_contact.title if lead_primary_contact else '') }}" placeholder="Job title" required {% if primary_contact and lead_primary_contact and primary_contact.lead_contact_id == lead_primary_contact.id %}disabled{% endif %}>
            </div>
            <div>
              <label for="primary-signer-email" class="claim-form-label-inline">Email <span class="claim-required-asterisk">*</span></label>
              <input type="email" id="primary-signer-email" value="{{ primary_contact.email if primary_contact else (lead_primary_contact.email if lead_primary_contact else '') }}" placeholder="email@example.com" required {% if primary_contact and lead_primary_contact and primary_contact.lead_contact_id == lead_primary_contact.id %}disabled{% endif %}>
            </div>
            <div>
              <label for="primary-signer-phone" class="claim-form-label-inline">Phone <span class="claim-required-asterisk">*</span></label>
              <input type="text" id="primary-signer-phone" value="{{ primary_contact.phone if primary_contact else (lead_primary_contact.phone if lead_primary_contact else '') }}" placeholder="(555) 123-4567" required {% if primary_contact and lead_primary_contact and primary_contact.lead_contact_id == lead_primary_contact.id %}disabled{% endif %}>
            </div>
          </div>
        </div>

        <!-- Secondary Signer (Optional) -->
        <div class="claim-section-divider">
          <div class="claim-flex-between claim-margin-bottom-sm">
            <h4>Secondary Signer <span class="claim-optional-label">(Optional)</span></h4>
            <label for="secondary-signer-enabled" class="claim-checkbox-label-large">
              <input type="checkbox" id="secondary-signer-enabled" class="claim-checkbox-input" {% if secondary_contact %}checked{% endif %}>
              <span>Add secondary signer</span>
            </label>
          </div>
          <div id="secondary-signer-fields" class="contact-fields" {% if not secondary_contact %}style="display: none;"{% endif %}>
            <div class="grid two-column claim-grid-gap-sm">
              <div>
                <label for="secondary-signer-first-name" class="claim-form-label-inline">First Name</label>
                <input type="text" id="secondary-signer-first-name" value="{{ secondary_contact.first_name if secondary_contact else '' }}" placeholder="First name">
              </div>
              <div>
                <label for="secondary-signer-last-name" class="claim-form-label-inline">Last Name</label>
                <input type="text" id="secondary-signer-last-name" value="{{ secondary_contact.last_name if secondary_contact else '' }}" placeholder="Last name">
              </div>
              <div>
                <label for="secondary-signer-title" class="claim-form-label-inline">Title</label>
                <input type="text" id="secondary-signer-title" value="{{ secondary_contact.title if secondary_contact else '' }}" placeholder="Job title">
              </div>
              <div>
                <label for="secondary-signer-email" class="claim-form-label-inline">Email</label>
                <input type="email" id="secondary-signer-email" value="{{ secondary_contact.email if secondary_contact else '' }}" placeholder="email@example.com">
              </div>
              <div>
                <label for="secondary-signer-phone" class="claim-form-label-inline">Phone</label>
                <input type="text" id="secondary-signer-phone" value="{{ secondary_contact.phone if secondary_contact else '' }}" placeholder="(555) 123-4567">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Check Mailing Address Card -->
      <div class="form-group claim-form-card">
        <div class="claim-flex-between claim-margin-bottom-sm">
          <h3 class="claim-margin-zero">Check Mailing Address <span class="claim-required-asterisk">*</span></h3>
          <label for="check-address-same-as-contact" class="claim-checkbox-label-large">
            <input type="checkbox" id="check-address-same-as-contact" class="claim-checkbox-input" {% if check_address_same_as_contact %}checked{% endif %}>
            <span>Use primary contact address</span>
          </label>
        </div>
        <div class="grid two-column claim-grid-gap-sm">
          <div>
            <label for="check-address-street" class="claim-form-label-inline">Street Address <span class="claim-required-asterisk">*</span></label>
            <input type="text" id="check-address-street" value="{{ check_address.street if check_address else (lead_primary_contact.address_street if lead_primary_contact else '') }}" placeholder="123 Main Street" required {% if check_address_same_as_contact %}disabled{% endif %}>
          </div>
          <div>
            <label for="check-address-line2" class="claim-form-label-inline">Address Line 2 <span class="claim-optional-label">(Optional)</span></label>
            <input type="text" id="check-address-line2" value="{{ check_address.line2 if check_address else '' }}" placeholder="Suite, Unit, etc." {% if check_address_same_as_contact %}disabled{% endif %}>
          </div>
          <div>
            <label for="check-address-city" class="claim-form-label-inline">City <span class="claim-required-asterisk">*</span></label>
            <input type="text" id="check-address-city" value="{{ check_address.city if check_address else (lead_primary_contact.address_city if lead_primary_contact else '') }}" placeholder="City" required {% if check_address_same_as_contact %}disabled{% endif %}>
          </div>
          <div>
            <label for="check-address-state" class="claim-form-label-inline">State <span class="claim-required-asterisk">*</span></label>
            <select id="check-address-state" class="claim-input-full" required {% if check_address_same_as_contact %}disabled{% endif %}>
              <option value="" {% if not check_address or not check_address.state %}selected{% endif %}>-- select --</option>
              {% for st in ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"] %}
              <option value="{{ st }}" {% if check_address and check_address.state == st %}selected{% elif not check_address and lead_primary_contact and lead_primary_contact.address_state == st %}selected{% endif %}>{{ st }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="check-address-zip" class="claim-form-label-inline">ZIP Code <span class="claim-required-asterisk">*</span></label>
            <input type="text" id="check-address-zip" value="{{ check_address.zip if check_address else (lead_primary_contact.address_zipcode if lead_primary_contact else '') }}" placeholder="12345" maxlength="10" required {% if check_address_same_as_contact %}disabled{% endif %}>
          </div>
        </div>
      </div>


      <!-- Save Button -->
      <div class="form-actions claim-form-actions-top">
        <button type="button" class="btn btn-primary claim-min-width-btn" id="save-client-claim-info-btn">Save Client & Claim Information</button>
        <span id="client-claim-info-status" class="text-muted claim-status-margin"></span>
      </div>
    </div>
  </section>

  <section class="card section-stack" data-claim-id="{{ claim.id }}">
    <header>
      <h2>Agreement Files</h2>
      <p class="text-muted">Outputs save to {{ claim.output_dir or 'claim folder' }}.</p>
    </header>
    <div class="section-content">
      <div class="form-actions claim-form-actions">
        <button type="button" class="btn btn-primary" id="claim-generate-btn">Generate Agreement Files</button>
        <span id="claim-status" class="text-muted"></span>
      </div>
      <div class="file-list claim-file-list-wrapper">
        <h4 class="claim-subtitle">Generated Files</h4>
        <ul id="claim-generated-list" class="claim-file-list"></ul>
      </div>
    </div>
  </section>

  <section class="card section-stack" data-claim-id="{{ claim.id }}">
    <header>
      <h2>Claim Package</h2>
    </header>
    <div class="section-content">
      <!-- Required Documents Checklist -->
      <div class="claim-package-section">
        <h3 class="claim-subheading">Required Documents</h3>
        <ul id="claim-required-list" class="claim-checklist"></ul>
      </div>

      <!-- Divider -->
      <div class="claim-package-divider"></div>

      <!-- Current Files -->
      <div class="claim-package-section">
        <h3 class="claim-subheading">Uploaded Files</h3>
        <ul id="claim-package-list" class="claim-file-list"></ul>
      </div>

      <!-- Divider -->
      <div class="claim-package-divider"></div>

      <!-- Upload Form -->
      <div class="claim-package-section">
        <h3 class="claim-subheading">Upload New File</h3>
        <form id="claim-upload-form" data-claim-id="{{ claim.id }}" enctype="multipart/form-data">
          <div class="grid two-column claim-upload-grid">
            <div>
              <label for="claim-doc-type" class="claim-form-label">Document Type</label>
              <select id="claim-doc-type" name="doc_type" required>
                <option value="agreement_signed">Agreement Signed</option>
                <option value="authorization_signed">Authorization Signed</option>
                <option value="addendum">Addendum</option>
                <option value="non_disclosure">Non Disclosure</option>
                <option value="fein_document">FEIN Document</option>
                <option value="id_verification">ID Verification</option>
                <option value="address_verification">Address Verification</option>
                <option value="b2b_relationship">B2B Relationship</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label for="claim-upload-notes" class="claim-form-label">Notes <span class="claim-optional-label">(optional)</span></label>
              <input id="claim-upload-notes" name="notes" type="text" placeholder="Notes or description">
            </div>
          </div>
          <div class="form-actions claim-form-actions claim-form-actions-inline">
            <div class="claim-flex-grow">
              <label for="claim-upload-file" class="claim-form-label">File <span class="claim-required-asterisk">*</span></label>
              <input id="claim-upload-file" name="file" type="file" required class="claim-file-input">
            </div>
            <div class="claim-form-actions-inline-end">
              <button type="submit" class="btn btn-secondary">Upload</button>
              <span id="claim-upload-status" class="text-muted"></span>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <section class="card section-stack" data-claim-id="{{ claim.id }}">
    <header>
      <h2>Audit Timeline</h2>
      <p class="text-muted">Status changes, generations, uploads, deletions.</p>
    </header>
    <div class="section-content">
      <div class="form-row audit-filter-row">
        <label class="text-muted">Filter</label>
        <div class="button-group" id="audit-filter">
          <button type="button" class="btn btn-ghost btn-sm audit-filter-btn active" data-filter="all">All</button>
          <button type="button" class="btn btn-ghost btn-sm audit-filter-btn" data-filter="status">Status</button>
          <button type="button" class="btn btn-ghost btn-sm audit-filter-btn" data-filter="files">Files</button>
        </div>
      </div>
      <ul id="claim-audit-list" class="audit-list"></ul>
    </div>
  </section>

  <!-- Preview Modal -->
  <div id="preview-modal" class="modal preview-modal">
    <div class="modal-content preview-modal-content">
      <div class="preview-modal-header">
        <div>
          <div id="preview-title" class="preview-title">Preview</div>
          <div id="preview-meta" class="text-muted preview-meta"></div>
        </div>
        <button type="button" class="btn btn-ghost" data-close-preview aria-label="Close preview">&times;</button>
      </div>
      <div class="preview-iframe-wrapper">
        <iframe id="preview-frame" src="" allow="clipboard-read; clipboard-write"></iframe>
      </div>
      <div class="preview-footer">
        <a id="preview-open-tab" href="#" target="_blank" class="btn btn-ghost btn-sm">Open in new tab</a>
        <div class="preview-footer-actions">
          <button id="preview-send-signature" type="button" class="btn btn-secondary btn-sm" disabled title="Coming soon">Send for Signature</button>
          <button type="button" class="btn btn-ghost btn-sm" data-close-preview>Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete File Confirmation Modal -->
  <div id="delete-file-modal" class="modal confirm-modal">
    <div class="modal-content confirm-modal-content">
      <div class="modal-header">
        <h2>Delete File</h2>
        <button type="button" class="modal-close" data-close-delete-file aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="delete-file-name"></strong>?</p>
        <p class="claim-text-muted-small">This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" data-close-delete-file>Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-file">Delete</button>
      </div>
    </div>
  </div>
</div>

<script src="/static/js/claims/claim_detail/api.js?v=20241227" defer></script>
<script src="/static/js/claims/claim_detail/render.js?v=20241227" defer></script>
<script src="/static/js/claims/claim_detail/index.js?v=20241227" defer></script>
{% endblock %}
