{# templates/properties.html #}
{% extends "base.html" %}
{% block content %}

<div class="page-with-sidebar">
  <aside class="filters-sidebar">
    <div class="filters-header">
      <h2>Filters</h2>
      <button type="button" class="btn btn-ghost btn-sm" id="clear-filters">Clear All</button>
    </div>

    <form id="filters-form" method="get" action="/properties">
      <input type="hidden" name="q" value="{{ q }}">
      <input type="hidden" name="page" value="1">

      <div class="filter-group">
        <label class="filter-label">Year</label>
        <div class="filter-controls">
          <select name="year" id="year" class="filter-select">
            {% for y in available_years %}
            <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Claim Authority</label>
        <div class="filter-controls">
          <select name="claim_authority" id="claim_authority" class="filter-select">
            <option value="">All</option>
            <option value="Unknown" {% if claim_authority == 'Unknown' %}selected{% endif %}>Unknown</option>
            <option value="Single" {% if not claim_authority or claim_authority == 'Single' %}selected{% endif %}>Single</option>
            <option value="Joint" {% if claim_authority == 'Joint' %}selected{% endif %}>Joint</option>
          </select>
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-block">Apply Filters</button>
    </form>
  </aside>

  <div class="page-content">
    <div class="page-header">
      <p class="page-subtitle">Total: {{ total }}</p>
      <form class="page-actions search-form-inline" method="get" action="/properties">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="claim_authority" value="{{ claim_authority }}">
        <div class="search-input-group">
          <input type="text" name="q" placeholder="Search by Property ID or Owner" value="{{ q }}" class="search-input">
          <button class="btn btn-secondary search-button" type="submit">Search</button>
        </div>
      </form>
    </div>

<table class="data-table properties-table">
  <thead>
    <tr>
      <th>Property ID</th>
      <th>Owner Name</th>
      <th>Amount</th>
      <th>Status</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for row in properties %}
    <tr class="property-row{% if row.assigned_to_lead %} is-assigned{% endif %}"
        data-property-id="{{ row.propertyid }}"
        data-order-id="{{ row.order_id }}"
        data-raw-hash="{{ row.raw_hash }}"
        data-row-index="{{ loop.index0 }}"
        data-assigned="{{ 'true' if row.assigned_to_lead else 'false' }}">
      <td class="property-id">{{ row.propertyid }}</td>
      <td>{{ row.ownername }}</td>
      <td>{{ row.propertyamount|currency }}</td>
      <td class="property-status">
        {% if row.assigned_to_lead %}
          <span class="status-pill status-pill-assigned">In Lead</span>
        {% else %}
          <span class="status-pill status-pill-available">Available</span>
        {% endif %}
      </td>
      <td class="property-actions">
        {% if row.assigned_to_lead %}
          <span class="linked-pill" title="Already linked to a lead">Linked</span>
        {% else %}
          <a class="add-lead-link" href="/leads/new_from_property?property_id={{ row.propertyid }}">Add to Lead</a>
        {% endif %}
        <button class="detail-trigger" type="button" aria-label="Expand property" title="View details">&#x2795;</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<div class="pager">
  <div class="pager-info">
    Page {{ page }} of {{ total_pages }}
  </div>
      <div class="pager-buttons">
  {% if page > 1 %}
      <a class="ghost-link" href="?page={{ page-1 }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if claim_authority %}&claim_authority={{ claim_authority|urlencode }}{% endif %}">Prev</a>
  {% endif %}
  {% if page < total_pages %}
      <a class="ghost-link" href="?page={{ page+1 }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if claim_authority %}&claim_authority={{ claim_authority|urlencode }}{% endif %}">Next</a>
  {% endif %}
  </div>
    </div>
  </div>
</div>

<dialog id="property-detail-dialog" class="property-detail-modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-body">
      <!-- property detail fragment will be injected here -->
    </div>
  </div>
</dialog>

<script src="/static/js/property_detail.js?v=20241128"></script>
<script src="/static/js/properties_filters.js?v=20241203"></script>
<script src="/static/js/properties_state.js?v=20241128"></script>

{% endblock %}
