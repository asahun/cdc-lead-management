{# templates/leads.html #}
{% extends "base.html" %}
{% block content %}

<div class="page-with-sidebar">
  <button type="button" id="filter-toggle" class="filter-toggle-btn" aria-label="Toggle filters" title="Toggle filters">
    <svg class="filter-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 5h14M5 10h10M7 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <circle cx="3" cy="5" r="1.5" fill="currentColor"/>
      <circle cx="10" cy="10" r="1.5" fill="currentColor"/>
      <circle cx="17" cy="15" r="1.5" fill="currentColor"/>
    </svg>
  </button>
  <aside class="filters-sidebar" id="filters-sidebar">
    <div class="filters-header">
      <h2>Filters</h2>
      <button type="button" class="btn btn-ghost btn-sm" id="clear-filters">Clear All</button>
    </div>

    <form id="filters-form" method="get" action="/leads">
      <input type="hidden" name="q" value="{{ q }}">
      <input type="hidden" name="page" value="1">

      <div class="filter-group">
        <label class="filter-label">Year</label>
        <div class="filter-controls">
          <select name="year" id="year" class="filter-select">
            {% for y in available_years %}
            <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Attempts</label>
        <div class="filter-controls">
          <select name="attempt_type" id="attempt_type" class="filter-select">
            <option value="all" {% if attempt_type == 'all' %}selected{% endif %}>All</option>
            <option value="email" {% if attempt_type == 'email' %}selected{% endif %}>Email</option>
            <option value="phone" {% if attempt_type == 'phone' %}selected{% endif %}>Phone</option>
            <option value="mail" {% if attempt_type == 'mail' %}selected{% endif %}>Mail</option>
            <option value="linkedin" {% if attempt_type == 'linkedin' %}selected{% endif %}>LinkedIn</option>
          </select>
          <select name="attempt_operator" id="attempt_operator" class="filter-select">
            <option value="">â€”</option>
            <option value=">=" {% if attempt_operator == '>=' %}selected{% endif %}>â‰¥</option>
            <option value="=" {% if attempt_operator == '=' %}selected{% endif %}>=</option>
            <option value="<=" {% if attempt_operator == '<=' %}selected{% endif %}>â‰¤</option>
          </select>
          <input type="number" name="attempt_count" id="attempt_count" class="filter-input" 
                 value="{{ attempt_count or '' }}" placeholder="Count" min="0">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Print Logs</label>
        <div class="filter-controls">
          <select name="print_log_operator" id="print_log_operator" class="filter-select">
            <option value="">â€”</option>
            <option value=">=" {% if print_log_operator == '>=' %}selected{% endif %}>â‰¥</option>
            <option value="=" {% if print_log_operator == '=' %}selected{% endif %}>=</option>
            <option value="<=" {% if print_log_operator == '<=' %}selected{% endif %}>â‰¤</option>
          </select>
          <input type="number" name="print_log_count" id="print_log_count" class="filter-input" 
                 value="{{ print_log_count or '' }}" placeholder="Count" min="0">
          <select name="print_log_mailed" id="print_log_mailed" class="filter-select">
            <option value="all" {% if print_log_mailed == 'all' %}selected{% endif %}>All</option>
            <option value="mailed" {% if print_log_mailed == 'mailed' %}selected{% endif %}>Mailed</option>
            <option value="not_mailed" {% if print_log_mailed == 'not_mailed' %}selected{% endif %}>Not Mailed</option>
          </select>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Scheduled Emails</label>
        <div class="filter-controls">
          <select name="scheduled_email_operator" id="scheduled_email_operator" class="filter-select">
            <option value="">â€”</option>
            <option value=">=" {% if scheduled_email_operator == '>=' %}selected{% endif %}>â‰¥</option>
            <option value="=" {% if scheduled_email_operator == '=' %}selected{% endif %}>=</option>
            <option value="<=" {% if scheduled_email_operator == '<=' %}selected{% endif %}>â‰¤</option>
          </select>
          <input type="number" name="scheduled_email_count" id="scheduled_email_count" class="filter-input" 
                 value="{{ scheduled_email_count or '' }}" placeholder="Count" min="0">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Failed Emails</label>
        <div class="filter-controls">
          <select name="failed_email_operator" id="failed_email_operator" class="filter-select">
            <option value="">â€”</option>
            <option value=">=" {% if failed_email_operator == '>=' %}selected{% endif %}>â‰¥</option>
            <option value="=" {% if failed_email_operator == '=' %}selected{% endif %}>=</option>
            <option value="<=" {% if failed_email_operator == '<=' %}selected{% endif %}>â‰¤</option>
          </select>
          <input type="number" name="failed_email_count" id="failed_email_count" class="filter-input" 
                 value="{{ failed_email_count or '' }}" placeholder="Count" min="0">
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">Status</label>
        <div class="filter-controls">
          <select name="status" id="status" class="filter-select">
            <option value="">All</option>
            <option value="new" {% if status == 'new' %}selected{% endif %}>New</option>
            <option value="researching" {% if status == 'researching' %}selected{% endif %}>Researching</option>
            <option value="ready" {% if status == 'ready' %}selected{% endif %}>Ready</option>
            <option value="contact_in_progress" {% if status == 'contact_in_progress' %}selected{% endif %}>Contact In Progress</option>
            <option value="response_received" {% if status == 'response_received' %}selected{% endif %}>Response Received</option>
            <option value="claim_created" {% if status == 'claim_created' %}selected{% endif %}>Claim Created</option>
            <option value="no_response" {% if status == 'no_response' %}selected{% endif %}>No Response</option>
            <option value="competitor_claimed" {% if status == 'competitor_claimed' %}selected{% endif %}>Competitor Claimed</option>
          </select>
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-block">Apply Filters</button>
</form>
  </aside>

  <div class="page-content">
    <div class="page-header">
      <p class="page-subtitle">Total leads: {{ total }}</p>
      <form class="page-actions search-form-inline" method="get" action="/leads">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="attempt_type" value="{{ attempt_type }}">
        <input type="hidden" name="attempt_operator" value="{{ attempt_operator }}">
        <input type="hidden" name="attempt_count" value="{{ attempt_count or '' }}">
        <input type="hidden" name="print_log_operator" value="{{ print_log_operator }}">
        <input type="hidden" name="print_log_count" value="{{ print_log_count or '' }}">
        <input type="hidden" name="print_log_mailed" value="{{ print_log_mailed }}">
        <input type="hidden" name="scheduled_email_operator" value="{{ scheduled_email_operator }}">
        <input type="hidden" name="scheduled_email_count" value="{{ scheduled_email_count or '' }}">
        <input type="hidden" name="failed_email_operator" value="{{ failed_email_operator }}">
        <input type="hidden" name="failed_email_count" value="{{ failed_email_count or '' }}">
        <input type="hidden" name="status" value="{{ status }}">
        <div class="search-input-group">
          <input type="text" name="q" placeholder="Search by Property ID or Owner" value="{{ q }}" class="search-input">
          <button class="btn btn-secondary search-button" type="submit">Search</button>
        </div>
      </form>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulk-actions-bar" class="bulk-actions-bar bulk-actions-bar-hidden">
      <div class="bulk-actions-info">
        <span id="bulk-selection-count">0</span> lead(s) selected
      </div>
      <div class="bulk-actions-buttons">
        <select id="bulk-status-select" class="bulk-action-select">
          <option value="">Change Status...</option>
          <option value="new">New</option>
          <option value="researching">Researching</option>
          <option value="ready">Ready</option>
          <option value="contact_in_progress">Contact In Progress</option>
          <option value="response_received">Response Received</option>
          <option value="claim_created">Claim Created</option>
          <option value="no_response">No Response</option>
          <option value="competitor_claimed">Competitor Claimed</option>
        </select>
        <button type="button" id="bulk-mark-mail-sent" class="btn btn-secondary btn-sm">Mark Mail Sent</button>
        <button type="button" id="bulk-clear-selection" class="btn btn-ghost btn-sm">Clear Selection</button>
      </div>
    </div>

    <div class="card">
      <table class="data-table leads-table">
  <thead>
    <tr>
      <th class="checkbox-column">
        <input type="checkbox" id="select-all-leads" title="Select all on this page">
      </th>
      <th>Tasks</th>
      <th>ID</th>
      <th>Property ID</th>
      <th>Owner</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Created</th>
            <th></th>
    </tr>
  </thead>
  <tbody>
        {% if not leads_with_data %}
          <tr><td colspan="9" class="table-empty-state">No leads found matching the filters.</td></tr>
        {% endif %}
        {% for l, is_editable, primary_prop, has_claim in leads_with_data %}
          <tr {% if l.status.value == 'competitor_claimed' %}class="lead-readonly"{% endif %}>
      <td class="checkbox-column">
        <input type="checkbox" class="lead-checkbox" data-lead-id="{{ l.id }}" {% if not is_editable %}disabled title="This lead cannot be edited"{% endif %}>
      </td>
      <td class="tasks-column">
        {% if l.status.value not in ['new', 'researching', 'invalid', 'competitor_claimed'] %}
          <button type="button" class="task-bell" data-lead-id="{{ l.id }}" title="View tasks">
            <span class="bell-icon">ðŸ””</span>
          </button>
        {% endif %}
      </td>
      <td>{{ l.id }}</td>
      <td>{{ primary_prop.property_id if primary_prop else 'â€”' }}</td>
      <td><span class="owner-name">{{ l.owner_name }}</span></td>
            <td>{{ primary_prop.property_amount|currency if primary_prop and primary_prop.property_amount else 'â€”' }}</td>
            <td>
              <span class="status-pill">{{ l.status.value }}</span>
              {% if has_claim %}
                <span class="status-pill status-pill-assigned status-pill-margin">Has Claim</span>
              {% endif %}
            </td>
      <td>
              <time class="js-local-time" datetime="{{ l.created_at.isoformat() }}">{{ l.created_at }}</time>
            </td>
            <td class="cell-actions">
              {% set filter_qs = "" %}
              {% if year or q or (attempt_type and attempt_type != 'all') or attempt_operator or attempt_count is not none or print_log_operator or print_log_count is not none or (print_log_mailed and print_log_mailed != 'all') or scheduled_email_operator or scheduled_email_count is not none or failed_email_operator or failed_email_count is not none or status %}
                {% set param_parts = [] %}
                {% if year %}{{ param_parts.append('year=' + year|string) or '' }}{% endif %}
                {% if q %}{{ param_parts.append('q=' + q|urlencode) or '' }}{% endif %}
                {% if attempt_type and attempt_type != 'all' %}{{ param_parts.append('attempt_type=' + attempt_type|urlencode) or '' }}{% endif %}
                {% if attempt_operator %}{{ param_parts.append('attempt_operator=' + attempt_operator|urlencode) or '' }}{% endif %}
                {% if attempt_count is not none %}{{ param_parts.append('attempt_count=' + attempt_count|string) or '' }}{% endif %}
                {% if print_log_operator %}{{ param_parts.append('print_log_operator=' + print_log_operator|urlencode) or '' }}{% endif %}
                {% if print_log_count is not none %}{{ param_parts.append('print_log_count=' + print_log_count|string) or '' }}{% endif %}
                {% if print_log_mailed and print_log_mailed != 'all' %}{{ param_parts.append('print_log_mailed=' + print_log_mailed|urlencode) or '' }}{% endif %}
                {% if scheduled_email_operator %}{{ param_parts.append('scheduled_email_operator=' + scheduled_email_operator|urlencode) or '' }}{% endif %}
                {% if scheduled_email_count is not none %}{{ param_parts.append('scheduled_email_count=' + scheduled_email_count|string) or '' }}{% endif %}
                {% if failed_email_operator %}{{ param_parts.append('failed_email_operator=' + failed_email_operator|urlencode) or '' }}{% endif %}
                {% if failed_email_count is not none %}{{ param_parts.append('failed_email_count=' + failed_email_count|string) or '' }}{% endif %}
                {% if status %}{{ param_parts.append('status=' + status|urlencode) or '' }}{% endif %}
                {% if param_parts %}{% set filter_qs = '?' + param_parts|join('&') %}{% endif %}
              {% endif %}
              <a href="/leads/{{ l.id }}/view{{ filter_qs }}">View</a>
              {% if is_editable %}
        <a href="/leads/{{ l.id }}/edit{{ filter_qs }}">Edit</a>
              {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

      <div class="pager">
        <div class="pager-info">
          Page {{ page }} of {{ total_pages }}
        </div>
        <div class="pager-buttons">
  {% if page > 1 %}
            <a class="ghost-link" href="?page={{ page-1 }}{% if year %}&year={{ year }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% if attempt_type and attempt_type != 'all' %}&attempt_type={{ attempt_type }}{% endif %}{% if attempt_operator %}&attempt_operator={{ attempt_operator }}{% endif %}{% if attempt_count is not none %}&attempt_count={{ attempt_count }}{% endif %}{% if print_log_operator %}&print_log_operator={{ print_log_operator }}{% endif %}{% if print_log_count is not none %}&print_log_count={{ print_log_count }}{% endif %}{% if print_log_mailed and print_log_mailed != 'all' %}&print_log_mailed={{ print_log_mailed }}{% endif %}{% if scheduled_email_operator %}&scheduled_email_operator={{ scheduled_email_operator }}{% endif %}{% if scheduled_email_count is not none %}&scheduled_email_count={{ scheduled_email_count }}{% endif %}{% if failed_email_operator %}&failed_email_operator={{ failed_email_operator }}{% endif %}{% if failed_email_count is not none %}&failed_email_count={{ failed_email_count }}{% endif %}{% if status %}&status={{ status }}{% endif %}">Prev</a>
  {% endif %}
  {% if page < total_pages %}
            <a class="ghost-link" href="?page={{ page+1 }}{% if year %}&year={{ year }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% if attempt_type and attempt_type != 'all' %}&attempt_type={{ attempt_type }}{% endif %}{% if attempt_operator %}&attempt_operator={{ attempt_operator }}{% endif %}{% if attempt_count is not none %}&attempt_count={{ attempt_count }}{% endif %}{% if print_log_operator %}&print_log_operator={{ print_log_operator }}{% endif %}{% if print_log_count is not none %}&print_log_count={{ print_log_count }}{% endif %}{% if print_log_mailed and print_log_mailed != 'all' %}&print_log_mailed={{ print_log_mailed }}{% endif %}{% if scheduled_email_operator %}&scheduled_email_operator={{ scheduled_email_operator }}{% endif %}{% if scheduled_email_count is not none %}&scheduled_email_count={{ scheduled_email_count }}{% endif %}{% if failed_email_operator %}&failed_email_operator={{ failed_email_operator }}{% endif %}{% if failed_email_count is not none %}&failed_email_count={{ failed_email_count }}{% endif %}{% if status %}&status={{ status }}{% endif %}">Next</a>
  {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Action Confirmation Modal -->
<div id="bulk-confirm-modal" class="modal">
  <div class="modal-content">
    <h3 id="bulk-confirm-title">Confirm Bulk Action</h3>
    <div id="bulk-confirm-message" class="bulk-confirm-message"></div>
    <div class="modal-actions">
      <button type="button" id="bulk-confirm-cancel" class="btn btn-ghost">Cancel</button>
      <button type="button" id="bulk-confirm-ok" class="btn btn-primary">Confirm</button>
    </div>
  </div>
</div>

<!-- Task Details Popup -->
<div id="task-popup" class="task-popup task-popup-hidden">
  <div class="task-popup-content">
    <div class="task-popup-header">
      <h3>Outreach Tasks</h3>
      <button type="button" class="task-popup-close" aria-label="Close">&times;</button>
    </div>
    <div class="task-popup-body">
      <div id="task-popup-loading" class="task-popup-loading">Loading tasks...</div>
      <div id="task-popup-content" class="task-popup-hidden">
        <div id="task-overdue-section" class="task-section task-section-hidden">
          <h4 class="task-section-title task-overdue">ðŸ”´ Overdue</h4>
          <ul id="task-overdue-list" class="task-list"></ul>
        </div>
        <div id="task-due-soon-section" class="task-section task-section-hidden">
          <h4 class="task-section-title task-due-soon">ðŸŸ¡ Due Soon (0-2 days)</h4>
          <ul id="task-due-soon-list" class="task-list"></ul>
        </div>
        <div id="task-upcoming-section" class="task-section task-section-hidden">
          <h4 class="task-section-title task-upcoming">ðŸ”µ Upcoming (3-7 days)</h4>
          <ul id="task-upcoming-list" class="task-list"></ul>
        </div>
        <div id="task-empty" class="task-empty task-empty-hidden">
          <p>No active tasks. All milestones are completed or not yet due.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/static/js/leads/list/leads_filters.js?v=20241203"></script>
<script src="/static/js/leads/list/leads_filters_persistence.js?v=20241203"></script>
<script src="/static/js/shared/filter_toggle.js?v=20241203" defer></script>
<link rel="stylesheet" href="/static/css/task_indicator.css">
<script src="/static/js/leads/list/task_indicator/api.js?v=20241203" defer></script>
<script src="/static/js/leads/list/task_indicator/helpers.js?v=20241203" defer></script>
<script src="/static/js/leads/list/task_indicator/render.js?v=20241203" defer></script>
<script src="/static/js/leads/list/task_indicator/index.js?v=20241203" defer></script>
<script src="/static/js/leads/list/leads_state.js?v=20241128"></script>
<script src="/static/js/leads/list/leads_bulk/api.js?v=20241203"></script>
<script src="/static/js/leads/list/leads_bulk/render.js?v=20241203"></script>
<script src="/static/js/leads/list/leads_bulk/index.js?v=20241203"></script>
{% endblock %}
